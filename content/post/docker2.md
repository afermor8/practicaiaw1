---
title: "Práctica 2: Implantación de aplicaciones web Python en Docker"
date: 2023-03-27T09:42:32+02:00
draft: true
tags: ["IAW"]
bigimg: [{src: "/img/triangle.jpg", desc: "Triangle"}, {src: "/img/sphere.jpg", desc: "Sphere"}, {src: "/img/hexagon.jpg", desc: "Hexagon"}]
---

Queremos desplegar en docker la aplicación escrita en python django: tutorial de django, que desplegamos en la tarea Despliegue de aplicaciones python.

Tienes que tener en cuenta los siguientes aspectos:

- La aplicación debe guardar los datos en una base de datos mariadb.
- La aplicación se podrá configurar para indicar los parámetros de conexión a la base de datos: usuario, contraseña, host y base de datos.
- La aplicación deberá tener creado un usuario administrador para el acceso.

Entrega:

1. Crea una imagen docker para poder desplegar un contenedor con la aplicación. La imagen la puedes hacer desde una imagen base o desde la imagen oficial de python.
2. Crea un docker-compose para desplegar los contenedores necesarios. Configura los volúmenes que creas necesarios para que la aplicación sea persistente.
3. Una vez probada en el entorno de desarrollo, despliega la aplicación en tu VPS usando el docker-compose y configurando el nginx como proxy inveso para acceder por nombre a la aplicación.

--------------------------------

## 1. Creación de imagen docker

En el entorno de desarrollo (máquina debiaprueba2) donde tengo clonado el repositorio django_tutorial,
creo una red y el contenedor mariadb.

```
sudo docker network create net_django

sudo docker run -d --name mariadb -v vol_polls:/var/lib/mysql --network net_django -e MARIADB_ROOT_PASSWORD=admin -e MARIADB_USER=django -e MARIADB_PASSWORD=admin -e MARIADB_DATABASE=django mariadb
```

Modifico settings.py, quedando de la siguiente forma:

```
cd git/django_tutorial

nano django_tutorial/settings.py
```

```
"""
Django settings for django_tutorial project.

Generated by 'django-admin startproject' using Django 3.1.3.

For more information on this file, see
https://docs.djangoproject.com/en/3.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.1/ref/settings/
"""

import os

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '9f0h)gozf$g%6igo8&767w1xro0adm+)msxe)!eic$!fhvynb8'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = [os.environ.get("ALLOWED_HOSTS")]


# Application definition

INSTALLED_APPS = [
    'polls.apps.PollsConfig',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'django_tutorial.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'django_tutorial.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.environ.get("DJANGO_DB"),
        'USER': os.environ.get('DJANGO_USER'),
        'PASSWORD': os.environ.get("DJANGO_PASSWORD"),
        'HOST': os.environ.get('DJANGO_HOST'),
        'PORT': '3306',
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.1/howto/static-files/

STATIC_ROOT = os.path.join(BASE_DIR, 'static')
STATIC_URL = '/static/'
CSRF_TRUSTED_ORIGINS = ['http://*.afm-tars.es','http://*.127.0.0.1','https://*.afm-tars.es','https://*.127.0.0.1']

DEFAULT_AUTO_FIELD='django.db.models.AutoField'
```

Creamos el siguiente script:

```
nano script.sh
```

```
#! /bin/sh

python3 manage.py makemigrations
python3 manage.py migrate
python3 manage.py createsuperuser --noinput
python3 manage.py collectstatic --noinput
python3 manage.py runserver 0.0.0.0:8006
```

Creo el Dockerfile:

```
nano Dockerfile
```

```
FROM python:3
WORKDIR /usr/src/app
MAINTAINER Arantxa Fernández Morató 'ara.fer.mor@gmail.com'
RUN apt-get install git && pip install --root-user-action=ignore --upgrade pip && pip install --root-user-action=ignore django mysqlclient
RUN git clone https://github.com/afermor8/django_tutorial.git /usr/src/app && mkdir static
ADD ./script.sh /usr/src/app/
RUN chmod +x /usr/src/app/script.sh
ENV ALLOWED_HOSTS=*
ENV DJANGO_HOST=mariadb
ENV DJANGO_USER=django
ENV DJANGO_PASSWORD=django
ENV DJANGO_DB=django
ENV DJANGO_SUPERUSER_PASSWORD=admin
ENV DJANGO_SUPERUSER_USERNAME=admin
ENV DJANGO_SUPERUSER_EMAIL=admin@example.org
ENTRYPOINT ["/usr/src/app/script.sh"]
```

Creo la imagen Docker:

```
sudo docker build -t afermor8/django:v1 .
```

Subo la imagen a Docker Hub.

```
sudo docker login -u afermor8

sudo docker push afermor8/django:v1
```

## 2. Creación de contenedores con docker-compose

Creo el fichero docker-compose:

```
nano docker-compose.yml
```

```
version: '3.7'
services:
  django-tutorial:
    container_name: django-tutorial
    image: afermor8/django:v1
    restart: always
    environment:
      ALLOWED_HOSTS: "*"
      DJANGO_HOST: bd_mariadb_django
      DJANGO_USER: django
      DJANGO_PASSWORD: django
      DJANGO_DB: django
      DJANGO_SUPERUSER_PASSWORD: admin
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@admin.org
    ports:
      - 8084:8006
    depends_on:
      - db_django
  db_django:
    container_name: bd_mariadb_django
    image: mariadb:latest
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: django
      MARIADB_USER: django
      MARIADB_PASSWORD: django
    volumes:
      - mariadb_data_django:/var/lib/mysql
volumes:
    mariadb_data_django:
```

Creamos los contenedores:

```
sudo docker-compose up -d
```

Comprobamos que se han creado los contenedores:

```
usuario@debianprueba2:~/git/django_tutorial$ sudo docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS                    NAMES
87898942e47a   afermor8/django:v1   "/usr/src/app/script…"   32 seconds ago   Up 30 seconds   0.0.0.0:8084->8006/tcp   django-tutorial
4e90af507bb5   mariadb:latest       "docker-entrypoint.s…"   32 seconds ago   Up 31 seconds   3306/tcp                 bd_mariadb_django
```

Comprobamos que la web funciona correctamente:

![](/img/docker/1.png)

![](/img/docker/2.png)

![](/img/docker/3.png)

![](/img/docker/4.png)

## 3. Despliegue en entorno de producción (en mi VPS)

En nuestro servidor DNS añadimos un registro CNAME.

![](/img/docker/5.png)

Generamos un certificado LetsEncrypt:

```
sudo systemctl stop nginx
sudo certbot certonly --standalone -d django-docker.afm-tars.es
sudo systemctl start nginx
```

Clonamos el repositorio:

```
cd git
git clone git@github.com:afermor8/django_tutorial.git
```

Descargamos la imagen:

```
sudo docker pull afermor8/django:v1
```

Levanto los contenedores:

```
cd django_tutorial
sudo docker-compose up -d
```

Creamos el virtualhost:

```
sudo nano /etc/nginx/sites-available/django-docker
```

```
server {
        listen 80;
        listen [::]:80;

        server_name django-docker.afm-tars.es;

        return 301 https://$host$request_uri;
}

server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        server_name django-docker.afm-tars.es;

        ssl_certificate /etc/letsencrypt/live/django-docker.afm-tars.es/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/django-docker.afm-tars.es/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;

        index index.html index.php index.htm index.nginx-debian.html;

        location / {
                proxy_pass http://localhost:8084;
                include proxy_params;
        }
}
```

Creamos el enlace simbólico:

```
sudo ln -s /etc/nginx/sites-available/django-docker /etc/nginx/sites-enabled/
```

Reiniciamos el servicio nginx:

```
sudo systemctl restart nginx
```

Para que aparezcan las preguntas que creamos en el servidor de desarrollo tenemos que copiar los datos de la siguiente forma:

- En desarrollo:

```
sudo docker exec bd_mariadb_django mysqldump -u django -pdjango django > backup.sql
scp backup.sql arantxa@217.160.225.205:.
```

- Y en el servidor vps:

```
sudo docker cp backup.sql db_mariadb_django:/backup.sql
sudo docker exec -it bd_mariadb_django bash
mysql -u django -p django < backup.sql
```

Accedemos en el navegador:

https://django-docker.afm-tars.es/

![](/img/docker/6.png)

![](/img/docker/7.png)

![](/img/docker/8.png)

![](/img/docker/9.png)
